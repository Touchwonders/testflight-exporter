#!/usr/bin/env ruby

$:.push File.expand_path("../lib", __FILE__)

require 'commander'
require 'highline'
require_relative '../lib/testflight_exporter/version'
require_relative '../lib/testflight_exporter'
require_relative '../lib/hockeyapp_uploader'

HighLine.track_eof = false


class TestFlightExporterApplication
  include Commander::Methods

  def run
    program :version, TestFlightExporter::VERSION
    program :description, 'CLI for \'Test Flight Exporter\' - Export your app binaries from Testflightapp.com in a fast and simple way'
    program :help, 'Author', 'Fabio Milano'
    program :help, 'Website', 'http://www.touchwonders.com'
    program :help_formatter, :compact

    global_option '--verbose'
    global_option '--username STRING', String, 'Your testflight account username'
    global_option '--password STRING', String, 'Your testflight account password'
    global_option '--output STRING', String, 'Path to your output folder where your binaries will be downloaded'
    global_option '--team STRING', String, 'Team name to process'

    always_trace!

    command :dump do |c|
      c.syntax = 'tfexporter migrate'
      c.description = 'Download your binaries from TestFlightapp.com'

      c.action do |args, options|
        ENV['VERBOSE_MODE'] = 'true' if options.verbose

        TestFlightExporter::Setup.new.setup(options.username, options.password, options.output, options.team)
      end
    end

    command :hockeyapp do |c|
      c.syntax = 'tfexporter hockeyapp'
      c.description = 'Helps you setting up all requirements to run a migration.'
      c.option '--token STRING', String, 'Your hockey app token'
      c.option '--input STRING', String, 'Your binaries folder'

      c.action do |args, options|
        ENV['VERBOSE_MODE'] = 'true' if options.verbose

        TestFlightExporter::HockeyAppUploader.new.run(options.token, options.input)
      end
    end

    default_command :migrate

    run!
  end
end

TestFlightExporterApplication.new.run
